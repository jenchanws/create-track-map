L.interpolatePosition=function(t,i,n,s){var e=s/n;return e=(e=e>0?e:0)>1?1:e,L.latLng(t.lat+e*(i.lat-t.lat),t.lng+e*(i.lng-t.lng))},L.Marker.MovingMarker=L.Marker.extend({statics:{notStartedState:0,endedState:1,pausedState:2,runState:3},options:{autostart:!1,loop:!1},initialize:function(t,i,n){L.Marker.prototype.initialize.call(this,t[0],n),this._latlngs=t.map(function(t,i){return L.latLng(t)}),i instanceof Array?this._durations=i:this._durations=this._createDurations(this._latlngs,i),this._currentDuration=0,this._currentIndex=0,this._state=L.Marker.MovingMarker.notStartedState,this._startTime=0,this._startTimeStamp=0,this._pauseStartTime=0,this._animId=0,this._animRequested=!1,this._currentLine=[],this._stations={}},isRunning:function(){return this._state===L.Marker.MovingMarker.runState},isEnded:function(){return this._state===L.Marker.MovingMarker.endedState},isStarted:function(){return this._state!==L.Marker.MovingMarker.notStartedState},isPaused:function(){return this._state===L.Marker.MovingMarker.pausedState},start:function(){!this.isRunning()&&(this.isPaused()?this.resume():(this._loadLine(0),this._startAnimation(),this.fire("start")))},resume:function(){this.isPaused()&&(this._currentLine[0]=this.getLatLng(),this._currentDuration-=this._pauseStartTime-this._startTime,this._startAnimation())},pause:function(){this.isRunning()&&(this._pauseStartTime=Date.now(),this._state=L.Marker.MovingMarker.pausedState,this._stopAnimation(),this._updatePosition())},stop:function(t){!this.isEnded()&&(this._stopAnimation(),void 0===t&&(t=0,this._updatePosition()),this._state=L.Marker.MovingMarker.endedState,this.fire("end",{elapsedTime:t}))},addLatLng:function(t,i){this._latlngs.push(L.latLng(t)),this._durations.push(i)},moveTo:function(t,i){this._stopAnimation(),this._latlngs=[this.getLatLng(),L.latLng(t)],this._durations=[i],this._state=L.Marker.MovingMarker.notStartedState,this.start(),this.options.loop=!1},addStation:function(t,i){!(t>this._latlngs.length-2)&&!(t<1)&&(this._stations[t]=i)},onAdd:function(t){if(L.Marker.prototype.onAdd.call(this,t),this.options.autostart&&!this.isStarted()){this.start();return}this.isRunning()&&this._resumeAnimation()},onRemove:function(t){L.Marker.prototype.onRemove.call(this,t),this._stopAnimation()},_createDurations:function(t,i){for(var n=t.length-1,s=[],e=0,a=0,r=0;r<n;r++)s.push(a=t[r+1].distanceTo(t[r])),e+=a;var o=i/e,h=[];for(r=0;r<s.length;r++)h.push(s[r]*o);return h},_startAnimation:function(){this._state=L.Marker.MovingMarker.runState,this._animId=L.Util.requestAnimFrame(function(t){this._startTime=Date.now(),this._startTimeStamp=t,this._animate(t)},this,!0),this._animRequested=!0},_resumeAnimation:function(){this._animRequested||(this._animRequested=!0,this._animId=L.Util.requestAnimFrame(function(t){this._animate(t)},this,!0))},_stopAnimation:function(){this._animRequested&&(L.Util.cancelAnimFrame(this._animId),this._animRequested=!1)},_updatePosition:function(){var t=Date.now()-this._startTime;this._animate(this._startTimeStamp+t,!0)},_loadLine:function(t){this._currentIndex=t,this._currentDuration=this._durations[t],this._currentLine=this._latlngs.slice(t,t+2)},_updateLine:function(t){var i,n=t-this._startTimeStamp;if(n<=this._currentDuration)return n;for(var s=this._currentIndex,e=this._currentDuration;n>e;){if(n-=e,void 0!==(i=this._stations[s+1])){if(n<i)return this.setLatLng(this._latlngs[s+1]),null;n-=i}if(++s>=this._latlngs.length-1){if(!this.options.loop)return this.setLatLng(this._latlngs[this._latlngs.length-1]),this.stop(n),null;s=0,this.fire("loop",{elapsedTime:n})}e=this._durations[s]}return this._loadLine(s),this._startTimeStamp=t-n,this._startTime=Date.now()-n,n},_animate:function(t,i){this._animRequested=!1;var n=this._updateLine(t);if(!this.isEnded()){if(null!=n){var s=L.interpolatePosition(this._currentLine[0],this._currentLine[1],this._currentDuration,n);this.setLatLng(s)}i||(this._animId=L.Util.requestAnimFrame(this._animate,this,!1),this._animRequested=!0)}}}),L.Marker.movingMarker=function(t,i,n){return new L.Marker.MovingMarker(t,i,n)};